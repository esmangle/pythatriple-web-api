<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Pythagorean Triple Finder</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<style>
		.mono {
			font-family: monospace;
		}
		.mono::placeholder {
			font-family: sans-serif;
		}
		.status-message {
			display: none;
			padding: 0.5rem;
			border-radius: 4px;
			margin-top: 0.5rem;
			font-weight: 500;
		}
		.status-message.status-info {
			color: #b6effb;
			background-color: #b6effb1a;
			border: 1px solid #b6effb;
		}
		.status-message.status-ok {
			color: #4caf50;
			background-color: #4caf501a;
			border: 1px solid #4caf50;
		}
		.status-message.status-fail {
			color: #f44336;
			background-color: #f443361a;
			border: 1px solid #f44336;
		}
		@keyframes fadeIn {
			from { opacity: 0; }
			to { opacity: 1; }
		}
		.status-message.status-show {
			animation: fadeIn 0.5s ease-in-out forwards;
		}
	</style>
	<script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
	<script defer>
	document.addEventListener("DOMContentLoaded", function() {
		"use strict";

		const numFormat = new Intl.NumberFormat("en", {
			minimumFractionDigits: 1, maximumFractionDigits: 2, useGrouping: false
		});

		const form = document.getElementById("formHypotSq");
		const input = document.getElementById("inputHypotSq");
		const button = document.getElementById("buttonSubmit");
		const spinner = document.getElementById("spinnerSubmit");
		const statusMsg = document.getElementById("statusMessage");
		const resultsTable = document.getElementById("resultsTable");

		const triplesMap = {};

		getAllTriples(list => {
			prependListToTable(list);
		}, error => {
			console.error("Error loading triples:", error);
			showStatus(`Error loading table: ${error.message}`, "fail");
		});

		let submissionDisabled = false;

		form.addEventListener("submit", function(e) {
			e.preventDefault();

			if (submissionDisabled) {
				return;
			}

			const hypotSq = parseInt(input.value);

			if (isNaN(hypotSq)) {
				return;
			}

			if (hypotSq <= 0) {
				showStatus("Fail: Input number must be a positive integer", "fail");
				return;
			}

			if (hypotSq > 0x7FFFFFFF) {
				showStatus("Fail: Input number is too large", "fail");
				return;
			}

			submissionDisabled = true;

			const updateButton = debounceWithDelay(
				150, 300,
				() => {
					button.disabled = true;
					spinner.classList.remove("d-none");
				},
				() => {
					submissionDisabled = false;
					button.disabled = false;
					spinner.classList.add("d-none");
				}
			);

			const updateStatus = debounceWithDelay(
				150, 300,
				() => showStatus(
					`Finding pythagorean triple for squared hypotenuse ${hypotSq}...`,
					"info"
				),
				() => showStatus(
					`Fail: No pythagorean triple found for ${hypotSq}`,
					"fail"
				)
			);

			getTriple(hypotSq, data => {
				if (Object.keys(data).length === 0) {
					updateStatus();
					return;
				}

				prependToTable(hypotSq, data);

				const msg = `Success: ${hypotSq} = ${data.a}² + ${data.b}² = ${data.c}² (average: ${numFormat.format(data.avg)})`;

				updateStatus(() => {
					showStatus(msg, "ok");
				});
			}, error => {
				const msg = error.hypotenuse_squared || error.message || "An error occurred";

				updateStatus(() => {
					showStatus(`Error: ${msg}`, "fail");
				});
			}, () => {
				updateButton();
			});
		});

		function getTriple(hypotSq, okFn, errFn, finallyFn) {
			fetch(`/api/triples?hypotenuse_squared=${encodeURIComponent(hypotSq)}`)
				.then(response => {
					if (!response.ok) {
						return response.json().then(err => { throw err; });
					}
					return response.json();
				})
				.then(okFn)
				.catch(errFn)
				.finally(finallyFn);
		}

		function getAllTriples(okFn, errFn, finallyFn) {
			fetch("/api/triples")
				.then(response => {
					if (!response.ok) {
						return response.json().then(err => { throw err; });
					}
					return response.json();
				})
				.then(okFn)
				.catch(errFn)
				.finally(finallyFn);
		}

		function createRow(hypotSq, data) {
			const row = document.createElement("tr");

			row.classList.add("col", "mono");

			[
				hypotSq, data.a, data.b, data.c, data.avg.toFixed(2)
			].map(val => {
				const td = document.createElement("td");
				td.textContent = val;
				return td;
			}).forEach(td => row.appendChild(td));

			return row;
		}

		function prependToTable(hypotSq, data) {
			if (hypotSq in triplesMap) {
				return;
			}

			triplesMap[hypotSq] = data;

			resultsTable.prepend(createRow(hypotSq, data));
		}

		function prependListToTable(list) {
			const frag = document.createDocumentFragment();

			for (const data of list) {
				const hypotSq = data.hypotSq;

				if (hypotSq in triplesMap) {
					continue;
				}

				triplesMap[hypotSq] = data;

				frag.append(createRow(hypotSq, data));
			}

			resultsTable.prepend(frag);
		}

		function showStatus(msg, type) {
			statusMessage.textContent = msg;
			statusMessage.classList.remove(
				"status-show", "status-info", "status-ok", "status-fail"
			);
			statusMessage.classList.add(`status-${type}`);
			statusMessage.style.display = "block";
			statusMessage.style.animation = "";
			void statusMessage.offsetWidth;
			statusMessage.classList.add("status-show");
		}

		// this is to prevent flickering due to fast response time
		function debounceWithDelay(debounceTime, minDelayTime, startFn, endFn) {
			let startTime = null;

			let timer = setTimeout(() => {
				startTime = Date.now();
				startFn();
			}, debounceTime);

			return (newEndFn) => {
				clearTimeout(timer);

				timer = setTimeout(
					newEndFn || endFn,
					startTime === null ? 0 : Math.max(
						0, minDelayTime - Date.now() + startTime
					)
				);
			}
		}
	});
	</script>
</head>
<body data-bs-theme="dark">
	<div class="container mt-5">
		<h1 class="text-center mb-4">Pythagorean Triple Finder</h1>

		<form id="formHypotSq" class="row justify-content-center mb-4">
			<div class="col-md-6">
				<div class="input-group">
					<input id="inputHypotSq" type="text" class="form-control mono"
						placeholder="Enter a squared hypotenuse (example: 25, 100, 169)"
						pattern="[0-9]*" required
						onkeypress="return event.key === 'Enter' || /\d/.test(event.key)">
					<button id="buttonSubmit" class="btn btn-primary" type="submit">
						<span id="spinnerSubmit" class="spinner-border spinner-border-sm d-none" role="status"></span>
						Submit
					</button>
				</div>
				<div id="statusMessage" class="status-message mt-4"></div>
			</div>
		</form>

		<div class="row justify-content-center mb-4">
			<div class="col-md-6">
				<table class="table table-striped table-bordered">
					<thead class="text-center">
						<tr>
							<th class="col">C squared</th>
							<th class="col">A</th>
							<th class="col">B</th>
							<th class="col">C</th>
							<th class="col">Average</th>
						</tr>
					</thead>
					<tbody id="resultsTable" class="text-center">
					</tbody>
				</table>
			</div>
		</div>
	</div>
</body>
</html>
